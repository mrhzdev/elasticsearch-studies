# Basics of Elasticsearch

## Data Structure

1. **INDEX** - in elastic it is a set of documents, making a parallel with RDB's systens, it is like a *database*.

2. **TYPE** - yet in the same parallel used above, types in elastic it is like a *table*.

3. **DOCUMENT** - it is a register in elastic, lika a *row* in SQL systems.

## Request

The Elasticsearch uses RESTful architecture to abstract interaction with Apache Lucene, who is the responsible to manage all the data.

### The HTTP Verbs:

- `POST` - This verb is used to **CREATE** a new document, but if an `ID` is passed as a param to request, the document will be created with the specified `ID`, if document already exist, it'll be **UPDATED**. The data of documents is 

- `GET` - This verb is used to **RETRIEVE** informations from server, if `ID` is passed to request, it will return just one document.

- `PUT` - It's the verb used to **UPDATE** a document. The `ID` parameter is **REQUIRED** 

- `DELETE` - This verb **DELETE** a document specified with the `ID` parameter passed. But it must be used carefully, because it allow you to **DELETE** your index, and all of your data in that index.

### Basics Request Example

#### Indexing a new document:

This is a basic request to index a new document by setting an `_id` to it.

```bash
curl -X PUT "{url}:{port}/{index}/{type}/{id}" \
-H 'Content-Type: application/json' \
-d '
{
  "field": "value",
  ...
}
'
```

For example in this request the `_index` is **store**, `_type` is **product**, its `_id` is **123**, and a `json` in the body of request defines the other fields of the document. The `pretty` parameter is just for server give us a pretty json response.

```bash
curl -X PUT "localhost:9200/store/product/123?pretty" \
-H 'Content-Type: application/json' \
-d '
{
  "name": "Notebook",
  "price":  900.50
}
'
```

The json below is a return of HTTP request made above. The json response indicating some things, like:

- `_index` - "index" which the document was stored.
- `_type` - "type" which the document was stored.
- `_id` - given "_id" which the document has received, it can be autogenerated.
- `_version` - Version of the document, this field is a auto-increment field.
- `result` - what is made about the given document, in this case it was *created*.

```json
{
  "_index" : "store",
  "_type" : "product",
  "_id" : "123",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}
```

The json below is the response of the server if the previous request shown here, is executed twice. Look at the `_version` and `result` fields. Version is incremented and the result indicates that dococument in this case was `updated`.

```json
{
  "_index" : "store",
  "_type" : "product",
  "_id" : "123",
  "_version" : 2,
  "result" : "updated",
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 1,
  "_primary_term" : 1
}
```

#### Autogenerating IDs

If you doesn't want to give an ID to the document, or it hasn't one, you let the Elasticsearch auto generate it for you. The request structure changes, in this case you must use te `POST` verb instead of `PUT`.

```bash
curl -X POST "{url}:{port}/{index}/{type}" \
-H 'Content-Type: application/json' \
-d '
{
  "field": "value",
  ...
}
'
```

This structure is like another specified previosly, except by the `method`, and the omission of the `id` parameter.

```bash
curl -X POST "localhost:9200/store/product?pretty" \
-H 'Content-Type: application/json' \
-d '
{
  "name": "Notebook",
  "price":  900.50
}
'
```

The json below is the response of request, and `_id` field was generate by Elasticsearch. If the request is made again, another document will be created with the same data, but with a completely diferent identifier. It means two equals documents, only differentiated by id.

```json
{
  "_index" : "store",
  "_type" : "product",
  "_id" : "ay_q428BLrPqOEo70_yp",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}
```

#### Bulk operation

Bulk operation provides a way to perform multiples `index`, `create`, `delete` and `update` actions at once request.

`POST /_bulk`

```bash
curl -X POST "{url}:{port}/_bulk?pretty" -H 'Content-Type: application/json' -d'
{ "index" : { "_index" : "(YOUR_INDEX)", "_type" : "(YOUR_TYPE)", "_id" : "(YOUR_ID)" } }
{ "field1" : "value1" }
'
```

Executing various commands on a specific index

`POST /<index>/_bulk`

```bash
curl -X POST "localhost:9200/store/_bulk?pretty" -H 'Content-Type: application/json' -d'
{"index":{ "_type":"product" } }
{"name": "Notebook", "price": "900.50"}
{"index":{ "_type":"product" } }
{"name": "SSD Card", "price": "52.90"}
{"index":{ "_index":"another_store", "_type":"product" } }
{"name": "Improved Notebook", "price": "900.50"}
'
```

The response of previous command

```json
{
  "took": 335,
  "errors": false,
  "items": [
    {
      "index": {
        "_index": "store",
        "_type": "product",
        "_id": "PnmW6m8Bj1qVAc7wnxWv",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 1,
          "failed": 0
        },
        "_seq_no": 0,
        "_primary_term": 1,
        "status": 201
      }
    },
    {
      "index": {
        "_index": "store",
        "_type": "product",
        "_id": "P3mW6m8Bj1qVAc7wnxWv",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 1,
          "failed": 0
        },
        "_seq_no": 1,
        "_primary_term": 1,
        "status": 201
      }
    },
    {
      "index": {
        "_index": "another_store",
        "_type": "product",
        "_id": "QHmW6m8Bj1qVAc7wnxWv",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 1,
        "_primary_term": 1,
        "status": 201
      }
    }
  ]
}
```

The data of body request must be of the following format:

```
action_and_meta_data\n
optional_source\n
action_and_meta_data\n
optional_source\n
....
action_and_meta_data\n
optional_source\n
```

The format must be a content type on the request header: `Content-type: application/x-ndjson`

Going further than indexing...

```bash
curl -X POST "localhost:9200/_bulk?pretty" -H 'Content-Type: application/json' -d'
{ "index" : { "_index" : "test", "_id" : "1" } }
{ "field1" : "value1" }
{ "delete" : { "_index" : "test", "_id" : "2" } }
{ "create" : { "_index" : "test", "_id" : "3" } }
{ "field1" : "value3" }
{ "update" : {"_id" : "1", "_index" : "test"} }
{ "doc" : {"field2" : "value2"} }
'
```

The response of previous command

```json
{
  "took": 374,
  "errors": false,
  "items": [
    {
      "index": {
        "_index": "test",
        "_type": "_doc",
        "_id": "1",
        "status": 201,
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 0,
        "_primary_term": 1
      }
    },
    {
      "delete": {
        "_index": "test",
        "_type": "_doc",
        "_id": "2",
        "_version": 1,
        "result": "not_found",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 1,
        "_primary_term": 1,
        "status": 404
      }
    },
    {
      "create": {
        "_index": "test",
        "_type": "_doc",
        "_id": "3",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 2,
        "_primary_term": 1,
        "status": 201
      }
    },
    {
      "update": {
        "_index": "test",
        "_type": "_doc",
        "_id": "1",
        "_version": 2,
        "result": "updated",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 3,
        "_primary_term": 1,
        "status": 200
      }
    }
  ]
}
```

##### Bulk "inserter" script

To perform a fast insert into elasticsearch. I built a simple python script([bulk.py](https://github.com/zabini/elasticsearch-studies/blob/master/utils/bulk.py)) that receive a json file with a list of documents(json objects), and turn these json documents into a ndjson output, ready to put it on body of a http request to elastic.

##### How to use

| Short Arg | Long Arg | Value Expected                | Text                                                            |
| :-------: | :------: | :---------------------------: | --------------------------------------------------------------- |
|  -f       |  --file  | `<path_to_json_file>`         | File path thats will be read (required)                         |
|  -i       |  --index | `<_index>`                    | Elasticsearch index                                             |
|  -t       |  --type  | `<_type>`                     | Elasticsearch type                                              |
|  -d       |  --id    | `<path.to.json.object.field>` | Converts a json path (element.propertie.id) to elasticsearch Id |
|  -h       |  --help  |                               | Display this help and exit                                      |

##### Using


Structure
```bash
./bulk.py --file <path_to_json_file> -d <path.to.json.object.field> -i <_index> -t <_type> | curl -X POST "localhost:9200/_bulk?pretty" -H 'Content-Type: application/json' --data-binary @-
```
